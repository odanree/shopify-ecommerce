{% comment %}
  Enhanced Product Card Component
  
  Usage:
  {% render 'product-card-enhanced', 
    product: product,
    show_badges: true,
    show_quick_view: true,
    image_ratio: 'square'
  %}
{% endcomment %}

{% liquid
  assign product_url = product.url | default: '#'
  assign product_title = product.title | default: 'Product Title'
  assign product_price = product.price | money
  assign compare_price = product.compare_at_price | money
  assign on_sale = false
  
  if product.compare_at_price > product.price
    assign on_sale = true
  endif
  
  assign image_ratio = image_ratio | default: 'portrait'
  assign show_badges = show_badges | default: true
  assign show_quick_view = show_quick_view | default: false
%}

<div class="product-card" data-product-id="{{ product.id }}">
  <div class="product-card__image-wrapper">
    {%- if product.featured_image -%}
      <a href="{{ product_url }}" class="product-card__image-link">
        <img
          srcset="
            {{ product.featured_image | image_url: width: 165 }} 165w,
            {{ product.featured_image | image_url: width: 360 }} 360w,
            {{ product.featured_image | image_url: width: 533 }} 533w,
            {{ product.featured_image | image_url: width: 720 }} 720w
          "
          src="{{ product.featured_image | image_url: width: 533 }}"
          sizes="(min-width: 990px) calc((100vw - 130px) / 4), (min-width: 750px) calc((100vw - 120px) / 3), calc((100vw - 35px) / 2)"
          alt="{{ product.featured_image.alt | escape }}"
          class="product-card__image"
          loading="lazy"
          width="{{ product.featured_image.width }}"
          height="{{ product.featured_image.height }}"
        >
        
        {%- comment -%} Hover image if available {%- endcomment -%}
        {%- if product.images[1] -%}
          <img
            src="{{ product.images[1] | image_url: width: 533 }}"
            alt="{{ product.images[1].alt | escape }}"
            class="product-card__image product-card__image--hover"
            loading="lazy"
          >
        {%- endif -%}
      </a>
    {%- else -%}
      <a href="{{ product_url }}" class="product-card__image-link">
        {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
      </a>
    {%- endif -%}
    
    {%- comment -%} Badges {%- endcomment -%}
    {%- if show_badges -%}
      <div class="product-card__badges">
        {%- if on_sale -%}
          <span class="badge badge--sale">Sale</span>
        {%- endif -%}
        
        {%- if product.available == false -%}
          <span class="badge badge--sold-out">Sold Out</span>
        {%- endif -%}
        
        {%- if product.tags contains 'new' -%}
          <span class="badge badge--new">New</span>
        {%- endif -%}
        
        {%- if product.tags contains 'top-rated' -%}
          <span class="badge badge--top-rated">‚≠ê Top Rated</span>
        {%- endif -%}
        
        {%- if product.tags contains 'waterproof' -%}
          <span class="badge badge--waterproof">üíß Waterproof</span>
        {%- endif -%}
        
        {%- if product.tags contains 'customizable' -%}
          <span class="badge badge--custom">‚úèÔ∏è Customizable</span>
        {%- endif -%}
      </div>
    {%- endif -%}
    
    {%- comment -%} Quick view button {%- endcomment -%}
    {%- if show_quick_view -%}
      <button 
        class="product-card__quick-view"
        data-product-url="{{ product_url }}"
        aria-label="Quick view {{ product_title }}"
      >
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
          <path d="M10 4C5 4 1.73 7.11 1 10c.73 2.89 4 6 9 6s8.27-3.11 9-6c-.73-2.89-4-6-9-6z" stroke="currentColor" stroke-width="2"/>
          <circle cx="10" cy="10" r="3" stroke="currentColor" stroke-width="2"/>
        </svg>
        Quick View
      </button>
    {%- endif -%}
  </div>
  
  <div class="product-card__details">
    <a href="{{ product_url }}" class="product-card__title">
      {{ product_title }}
    </a>
    
    {%- comment -%} Variant count {%- endcomment -%}
    {%- if product.variants.size > 1 -%}
      <div class="product-card__variants">
        {% if product.options_with_values.size > 0 %}
          {% assign first_option = product.options_with_values[0] %}
          <span class="product-card__variant-count">
            {{ product.variants.size }} {{ first_option.name }}s
          </span>
        {% endif %}
      </div>
    {%- endif -%}
    
    {%- comment -%} Price {%- endcomment -%}
    <div class="product-card__price">
      {%- if on_sale -%}
        <span class="product-card__price--sale">{{ product_price }}</span>
        <span class="product-card__price--compare">{{ compare_price }}</span>
        
        {%- comment -%} Calculate savings percentage {%- endcomment -%}
        {%- liquid
          assign price_diff = product.compare_at_price | minus: product.price
          assign savings = price_diff | times: 100.0 | divided_by: product.compare_at_price | round
        -%}
        <span class="product-card__savings">Save {{ savings }}%</span>
      {%- else -%}
        {%- if product.price_varies -%}
          <span class="product-card__price--from">From {{ product.price_min | money }}</span>
        {%- else -%}
          <span class="product-card__price--regular">{{ product_price }}</span>
        {%- endif -%}
      {%- endif -%}
    </div>
    
    {%- comment -%} Color swatches if applicable {%- endcomment -%}
    {%- if product.options contains 'Color' -%}
      <div class="product-card__swatches">
        {%- assign color_option = product.options_with_values | where: 'name', 'Color' | first -%}
        {%- for value in color_option.values limit: 5 -%}
          <span 
            class="product-card__swatch" 
            style="background-color: {{ value | handle }};"
            title="{{ value }}"
          ></span>
        {%- endfor -%}
        {%- if color_option.values.size > 5 -%}
          <span class="product-card__swatch-more">+{{ color_option.values.size | minus: 5 }}</span>
        {%- endif -%}
      </div>
    {%- endif -%}
    
    {%- comment -%} Add to cart button {%- endcomment -%}
    {%- if product.available -%}
      {%- if product.variants.size == 1 -%}
        <button 
          class="product-card__add-to-cart btn btn--primary"
          data-product-id="{{ product.id }}"
          data-variant-id="{{ product.selected_or_first_available_variant.id }}"
        >
          Add to Cart
        </button>
      {%- else -%}
        <a href="{{ product_url }}" class="product-card__select-options btn btn--secondary">
          Select Options
        </a>
      {%- endif -%}
    {%- else -%}
      <button class="product-card__sold-out btn btn--disabled" disabled>
        Sold Out
      </button>
    {%- endif -%}
    
    {%- comment -%} Reviews/Rating if available {%- endcomment -%}
    {%- if product.metafields.reviews.rating.value -%}
      <div class="product-card__reviews">
        <div class="product-card__stars" role="img" aria-label="{{ product.metafields.reviews.rating.value }} out of 5 stars">
          {%- assign rating = product.metafields.reviews.rating.value | round -%}
          {%- for i in (1..5) -%}
            {%- if i <= rating -%}
              <span class="star star--filled">‚òÖ</span>
            {%- else -%}
              <span class="star star--empty">‚òÜ</span>
            {%- endif -%}
          {%- endfor -%}
        </div>
        {%- if product.metafields.reviews.rating_count -%}
          <span class="product-card__review-count">
            ({{ product.metafields.reviews.rating_count }})
          </span>
        {%- endif -%}
      </div>
    {%- endif -%}
  </div>
</div>

<style>
  .product-card {
    position: relative;
    display: flex;
    flex-direction: column;
    height: 100%;
  }
  
  .product-card__image-wrapper {
    position: relative;
    overflow: hidden;
    border-radius: 8px;
    margin-bottom: 12px;
  }
  
  .product-card__image-link {
    display: block;
    position: relative;
  }
  
  .product-card__image {
    width: 100%;
    height: auto;
    display: block;
    transition: opacity 0.3s ease;
  }
  
  .product-card__image--hover {
    position: absolute;
    top: 0;
    left: 0;
    opacity: 0;
  }
  
  .product-card__image-wrapper:hover .product-card__image--hover {
    opacity: 1;
  }
  
  .product-card__badges {
    position: absolute;
    top: 8px;
    left: 8px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    z-index: 1;
  }
  
  .badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    display: inline-block;
  }
  
  .badge--sale {
    background: #ff4444;
    color: white;
  }
  
  .badge--new {
    background: #7eb77f;
    color: white;
  }
  
  .badge--sold-out {
    background: #666;
    color: white;
  }
  
  .badge--top-rated,
  .badge--waterproof,
  .badge--custom {
    background: white;
    color: #333;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .product-card__quick-view {
    position: absolute;
    bottom: 8px;
    left: 50%;
    transform: translateX(-50%) translateY(100%);
    background: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  
  .product-card__image-wrapper:hover .product-card__quick-view {
    transform: translateX(-50%) translateY(0);
  }
  
  .product-card__details {
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  
  .product-card__title {
    font-size: 16px;
    font-weight: 500;
    margin-bottom: 8px;
    color: #333;
    text-decoration: none;
  }
  
  .product-card__title:hover {
    color: #7eb77f;
  }
  
  .product-card__price {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
  }
  
  .product-card__price--sale {
    color: #ff4444;
    font-weight: 600;
  }
  
  .product-card__price--compare {
    text-decoration: line-through;
    color: #999;
    font-size: 14px;
  }
  
  .product-card__savings {
    background: #ffe6e6;
    color: #ff4444;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 12px;
    font-weight: 600;
  }
  
  .product-card__swatches {
    display: flex;
    gap: 6px;
    align-items: center;
    margin-bottom: 12px;
  }
  
  .product-card__swatch {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: 2px solid #ddd;
    cursor: pointer;
  }
  
  .product-card__swatch-more {
    font-size: 12px;
    color: #666;
  }
  
  .btn {
    padding: 10px 20px;
    border-radius: 4px;
    font-weight: 600;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
    text-decoration: none;
    display: inline-block;
  }
  
  .btn--primary {
    background: #7eb77f;
    color: white;
  }
  
  .btn--primary:hover {
    background: #6da36e;
  }
  
  .btn--secondary {
    background: white;
    color: #333;
    border: 2px solid #333;
  }
  
  .btn--disabled {
    background: #ccc;
    color: #666;
    cursor: not-allowed;
  }
  
  .product-card__reviews {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-top: 8px;
    font-size: 14px;
  }
  
  .star {
    color: #ffc107;
  }
</style>

<script>
  // Quick view functionality
  document.querySelectorAll('.product-card__quick-view').forEach(button => {
    button.addEventListener('click', (e) => {
      e.preventDefault();
      const productUrl = button.dataset.productUrl;
      // Implement your quick view modal logic here
      console.log('Quick view:', productUrl);
    });
  });
  
  // Quick add to cart
  document.querySelectorAll('.product-card__add-to-cart').forEach(button => {
    button.addEventListener('click', async (e) => {
      e.preventDefault();
      const variantId = button.dataset.variantId;
      
      try {
        const response = await fetch('/cart/add.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            id: variantId,
            quantity: 1
          })
        });
        
        if (response.ok) {
          button.textContent = '‚úì Added!';
          button.classList.add('success');
          setTimeout(() => {
            button.textContent = 'Add to Cart';
            button.classList.remove('success');
          }, 2000);
          
          // Update cart count or open cart drawer
          // Implement your cart update logic here
        }
      } catch (error) {
        console.error('Error adding to cart:', error);
        button.textContent = 'Error';
      }
    });
  });
</script>
